(window["webpackJsonp_cmdb"]=window["webpackJsonp_cmdb"]||[]).push([["chunk-a3ac49b4","chunk-2d213107"],{7281:function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e._self._c;return t("div",[t("Modal",{attrs:{title:"选择主机",width:"950","mask-closable":!1,"footer-hide":!0},model:{value:e.dialog.show,callback:function(t){e.$set(e.dialog,"show",t)},expression:"dialog.show"}},[t("alert",[e._v("一共查询到:"+e._s(e.totalCount)+"条数据")]),t("Input",{staticStyle:{width:"330px",margin:"0px"},attrs:{clearable:"",placeholder:"输入实例ID、主机名、内网IP搜索",search:""},on:{"on-change":e.handleFilter},nativeOn:{keydown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleFilter.apply(null,arguments)}},model:{value:e.searchVal,callback:function(t){e.searchVal=t},expression:"searchVal"}}),t("div",{staticStyle:{"margin-top":"5px"}},[t("Table",{ref:"table",attrs:{"highlight-row":"",stripe:"",size:"small",columns:e.columnsData,data:e.tableData}})],1),t("div",{staticStyle:{margin:"10px",overflow:"hidden"}},[t("Page",{attrs:{total:e.totalCount,current:e.pageNum,"page-size":e.pageSize,"show-total":""},on:{"on-change":e.handlerChangePage}})],1)],1)],1)},r=[],s=(a("d9e2"),a("aaa2")),n=(a("56b3"),a("b719"),{name:"BindHost",props:{dialog:{type:Object,default:{}}},data(){return{serverList:[],serverFilteredList:[],boundServerIds:[],tableData:[],searchVal:"",agentInstanceId:0,pageTotal:0,pageSize:10,pageNum:1,columnsData:[{title:"实例名称",key:"name",align:"center",minWidth:100,sortable:!0},{title:"内网IP",key:"inner_ip",align:"center",width:140,sortable:!0},{title:"可用区",key:"region",align:"center",width:140,sortable:!0},{title:"厂商",key:"cloud_name",align:"center",width:140,sortable:!0},{title:"是否有主agent",key:"has_main_agent",align:"center",width:140,sortable:!0,render:(e,t)=>{const a=t.row.has_main_agent;return e("div",!0===a?[e("Tag",{props:{color:"#19be6b"}},"是")]:[e("Tag",{props:{color:"#ed3f14"}},"否")])}},{title:"操作",key:"action",width:150,align:"center",render:(e,t)=>{const a=t.row.is_bound_to_this_agent||t.row.agent_id&&this.boundServerIds.includes(t.row.id);return e("div",[a?e("Button",{props:{type:"success",size:"small"},style:{marginRight:"5px"},on:{click:()=>{this.setMainAgent(t.row)}}},"已绑定"):e("Button",{props:{type:"primary",size:"small"},style:{marginRight:"5px"},on:{click:()=>{this.setMainAgent(t.row)}}},"绑定")])}}]}},computed:{totalCount(){return this.serverFilteredList.length}},watch:{"dialog.show":function(e){e&&(this.initData(),this.setCurrentPageData())}},methods:{handleConfirm(){this.currentRow&&(this.$emit("on-select",this.currentRow),this.dialog.show=!1)},processServerData(e,t){if(!e||!Array.isArray(e))return{sortedServers:[],boundServerIds:[]};const a=e.filter(e=>e.agent_id===t),i=a.map(e=>e.id),r=e.map(e=>({...e,is_bound_to_this_agent:e.agent_id===t})),s=r.sort((e,t)=>e.is_bound_to_this_agent&&!t.is_bound_to_this_agent?-1:!e.is_bound_to_this_agent&&t.is_bound_to_this_agent?1:e.id-t.id);return{sortedServers:s,boundServerIds:i}},loadServerData(e,t,a){if(!e||!t)return void this.$Message.error("无效的数据参数");const{sortedServers:i,boundServerIds:r}=this.processServerData(e,t);this.serverList=i,this.boundServerIds=r,this.agentInstanceId=a,this.initData(),this.setCurrentPageData()},showConfirmDialog(e){let t=!1;return new Promise((a,i)=>{this.$Modal.confirm({title:"确认修改",render:e=>e("div",[e("p","当前该主机已绑定主agent，请确认是否将本agent设为主agent？"),e("div",{style:{marginTop:"16px",display:"flex",alignItems:"center"}},[e("Checkbox",{props:{value:t},on:{"on-change":e=>{t=e}},style:{marginRight:"8px"}}),e("span","设为主agent")])]),onOk:async()=>{try{e.set_main_agent=t,await this.updateMainAgent(e,t),a({success:!0,setMainAgent:t})}catch(r){i(r)}},onCancel:()=>{a()}})})},showSetMainConfirm(e){return new Promise((t,a)=>{let i=!1;this.$Modal.confirm({title:"确认修改",render:e=>e("div",[e("p","请确认是否将本agent绑定到该主机，并设置为主agent？"),e("div",{style:{marginTop:"16px",display:"flex",alignItems:"center"}},[e("Checkbox",{props:{value:i},on:{"on-change":e=>{i=e}},style:{marginRight:"8px"}}),e("span","设为主agent")])]),onOk:async()=>{try{await this.updateMainAgent(e,i),t({success:!0,setAsMain:i})}catch(r){a(r)}},onCancel:()=>{t({success:!1,setAsMain:!1})}})})},async updateMainAgent(e,t){try{const a={server_id:e.id,agent_instance_id:this.agentInstanceId,main_agent:t},i=await Object(s["optServerMainAgent"])(a,"post");if(0!==i.code)throw new Error(i.msg||"操作失败");this.$Message.success("设置成功"),this.dialog.show=!1,this.$emit("refresh"),this.$emit("bind-complete")}catch(a){throw a}},async setMainAgent(e){try{e.has_main_agent&&0!==e.bind_agnet_status?await this.showConfirmDialog(e):await this.showSetMainConfirm(e)}catch(t){this.$Message.error("设置主Agent失败: "+t.message)}},handlerChangePage(e){this.pageNum=e,this.setCurrentPageData()},setCurrentPageData(){const e=(this.pageNum-1)*this.pageSize,t=this.pageNum*this.pageSize;this.tableData=this.serverFilteredList.slice(e,t)},checkRegion(e){return e.region.indexOf(this.region)>=0},checkExecList(e){return e.name.indexOf(this.searchVal)>=0||e.cloud_name.indexOf(this.searchVal)>=0||e.inner_ip&&e.inner_ip.indexOf(this.searchVal)>=0||e.region&&e.region.indexOf(this.searchVal)>=0},handleFilter(){this.pageNum=1,this.searchVal?(this.searchVal=this.searchVal.trim(),this.serverFilteredList=this.serverList.filter(this.checkExecList)):this.serverFilteredList=this.serverList,this.setCurrentPageData()},initData(){this.serverFilteredList=this.serverList,this.pageNum=1,this.pageSize=10,this.searchVal=""}}}),o=n,l=a("2877"),d=Object(l["a"])(o,i,r,!1,null,null,null);t["default"]=d.exports},aaa2:function(e,t,a){"use strict";a.r(t),a.d(t,"getServerList",(function(){return r})),a.d(t,"optServer",(function(){return s})),a.d(t,"optBatchServer",(function(){return n})),a.d(t,"getUserField",(function(){return o})),a.d(t,"optrationUserField",(function(){return l})),a.d(t,"optServerMainAgent",(function(){return d}));var i=a("be3b");const r=e=>Object(i["default"])({url:"/api/v2/cmdb/server/",method:"get",params:e}),s=(e,t)=>Object(i["default"])({url:"/api/v2/cmdb/server/",method:t,data:e}),n=(e,t)=>Object(i["default"])({url:"/api/v2/cmdb/server/batch/",method:t,data:e}),o=e=>Object(i["default"])({url:"/api/v2/cmdb/user_field/",method:"get",params:e}),l=e=>Object(i["default"])({url:"/api/v2/cmdb/user_field/",method:"put",data:e}),d=(e,t)=>Object(i["default"])({url:"/api/v2/cmdb/server/main_agent/",method:t,data:e})}}]);
//# sourceMappingURL=chunk-a3ac49b4.7dad91ed.js.map