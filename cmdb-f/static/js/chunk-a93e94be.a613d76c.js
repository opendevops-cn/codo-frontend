(window["webpackJsonp_cmdb"]=window["webpackJsonp_cmdb"]||[]).push([["chunk-a93e94be","chunk-a3ac49b4","chunk-8f5a13ae","chunk-2d0bac40","chunk-2d213107"],{"00c4":function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e._self._c;return t("Modal",{attrs:{title:e.modalData.title,"footer-hide":!0},model:{value:e.modalData.show,callback:function(t){e.$set(e.modalData,"show",t)},expression:"modalData.show"}},[t("Select",{attrs:{filterable:"",clearable:"",placeholder:"请选择主机"},model:{value:e.asset_server_id,callback:function(t){e.asset_server_id=t},expression:"asset_server_id"}},e._l(e.serverList,(function(e){return t("Option",{key:e.id,attrs:{value:e.id,label:e.name}})})),1),t("Button",{staticStyle:{"margin-top":"10px"},attrs:{type:"success",loading:e.btnLoading,long:""},on:{click:e.handleChangeSave}},[e._v("确定更换")])],1)},s=[],n=a("aaa2"),r={name:"serverModal",props:{modalData:{type:Object,default:{}}},data(){return{asset_server_id:null,btnLoading:!1,serverList:[],initPara:{page_number:1,page_size:300}}},methods:{async handleGetData(){const e=await Object(n["getServerList"])(this.initPara);0==e.code?this.serverList=e.data:this.$Message.error(e.msg)},handleChangeSave(){this.asset_server_id?(this.btnLoading=!0,setTimeout(()=>{this.$emit("save-data",{id:this.modalData.id,asset_server_id:this.asset_server_id}),this.btnLoading=!1},1e3)):this.$Message.info("请选择主机")}},watch:{},created(){},mounted(){this.handleGetData()}},o=r,l=a("2877"),d=Object(l["a"])(o,i,s,!1,null,null,null);t["default"]=d.exports},3937:function(e,t,a){"use strict";a.r(t),a.d(t,"getAgentlist",(function(){return s})),a.d(t,"optAgent",(function(){return n})),a.d(t,"batchAddServerByAgent",(function(){return r}));var i=a("be3b");const s=e=>Object(i["default"])({url:"/api/v2/cmdb/agent/",method:"get",params:e}),n=(e,t)=>Object(i["default"])({url:"/api/v2/cmdb/agent/",method:t,data:e}),r=(e,t)=>Object(i["default"])({url:"/api/v2/cmdb/agent/batch_add_server/",method:t,data:e})},7281:function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e._self._c;return t("div",[t("Modal",{attrs:{title:"选择主机",width:"950","mask-closable":!1,"footer-hide":!0},model:{value:e.dialog.show,callback:function(t){e.$set(e.dialog,"show",t)},expression:"dialog.show"}},[t("alert",[e._v("一共查询到:"+e._s(e.totalCount)+"条数据")]),t("Input",{staticStyle:{width:"330px",margin:"0px"},attrs:{clearable:"",placeholder:"输入实例ID、主机名、内网IP搜索",search:""},on:{"on-change":e.handleFilter},nativeOn:{keydown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleFilter.apply(null,arguments)}},model:{value:e.searchVal,callback:function(t){e.searchVal=t},expression:"searchVal"}}),t("div",{staticStyle:{"margin-top":"5px"}},[t("Table",{ref:"table",attrs:{"highlight-row":"",stripe:"",size:"small",columns:e.columnsData,data:e.tableData}})],1),t("div",{staticStyle:{margin:"10px",overflow:"hidden"}},[t("Page",{attrs:{total:e.totalCount,current:e.pageNum,"page-size":e.pageSize,"show-total":""},on:{"on-change":e.handlerChangePage}})],1)],1)],1)},s=[],n=(a("d9e2"),a("aaa2")),r=(a("56b3"),a("b719"),{name:"BindHost",props:{dialog:{type:Object,default:{}}},data(){return{serverList:[],serverFilteredList:[],boundServerIds:[],tableData:[],searchVal:"",agentInstanceId:0,pageTotal:0,pageSize:10,pageNum:1,columnsData:[{title:"实例名称",key:"name",align:"center",minWidth:100,sortable:!0},{title:"内网IP",key:"inner_ip",align:"center",width:140,sortable:!0},{title:"可用区",key:"region",align:"center",width:140,sortable:!0},{title:"厂商",key:"cloud_name",align:"center",width:140,sortable:!0},{title:"是否有主agent",key:"has_main_agent",align:"center",width:140,sortable:!0,render:(e,t)=>{const a=t.row.has_main_agent;return e("div",!0===a?[e("Tag",{props:{color:"#19be6b"}},"是")]:[e("Tag",{props:{color:"#ed3f14"}},"否")])}},{title:"操作",key:"action",width:150,align:"center",render:(e,t)=>{const a=t.row.is_bound_to_this_agent||t.row.agent_id&&this.boundServerIds.includes(t.row.id);return e("div",[a?e("Button",{props:{type:"success",size:"small"},style:{marginRight:"5px"},on:{click:()=>{this.setMainAgent(t.row)}}},"已绑定"):e("Button",{props:{type:"primary",size:"small"},style:{marginRight:"5px"},on:{click:()=>{this.setMainAgent(t.row)}}},"绑定")])}}]}},computed:{totalCount(){return this.serverFilteredList.length}},watch:{"dialog.show":function(e){e&&(this.initData(),this.setCurrentPageData())}},methods:{handleConfirm(){this.currentRow&&(this.$emit("on-select",this.currentRow),this.dialog.show=!1)},processServerData(e,t){if(!e||!Array.isArray(e))return{sortedServers:[],boundServerIds:[]};const a=e.filter(e=>e.agent_id===t),i=a.map(e=>e.id),s=e.map(e=>({...e,is_bound_to_this_agent:e.agent_id===t})),n=s.sort((e,t)=>e.is_bound_to_this_agent&&!t.is_bound_to_this_agent?-1:!e.is_bound_to_this_agent&&t.is_bound_to_this_agent?1:e.id-t.id);return{sortedServers:n,boundServerIds:i}},loadServerData(e,t,a){if(!e||!t)return void this.$Message.error("无效的数据参数");const{sortedServers:i,boundServerIds:s}=this.processServerData(e,t);this.serverList=i,this.boundServerIds=s,this.agentInstanceId=a,this.initData(),this.setCurrentPageData()},showConfirmDialog(e){let t=!1;return new Promise((a,i)=>{this.$Modal.confirm({title:"确认修改",render:e=>e("div",[e("p","当前该主机已绑定主agent，请确认是否将本agent设为主agent？"),e("div",{style:{marginTop:"16px",display:"flex",alignItems:"center"}},[e("Checkbox",{props:{value:t},on:{"on-change":e=>{t=e}},style:{marginRight:"8px"}}),e("span","设为主agent")])]),onOk:async()=>{try{e.set_main_agent=t,await this.updateMainAgent(e,t),a({success:!0,setMainAgent:t})}catch(s){i(s)}},onCancel:()=>{a()}})})},showSetMainConfirm(e){return new Promise((t,a)=>{let i=!1;this.$Modal.confirm({title:"确认修改",render:e=>e("div",[e("p","请确认是否将本agent绑定到该主机，并设置为主agent？"),e("div",{style:{marginTop:"16px",display:"flex",alignItems:"center"}},[e("Checkbox",{props:{value:i},on:{"on-change":e=>{i=e}},style:{marginRight:"8px"}}),e("span","设为主agent")])]),onOk:async()=>{try{await this.updateMainAgent(e,i),t({success:!0,setAsMain:i})}catch(s){a(s)}},onCancel:()=>{t({success:!1,setAsMain:!1})}})})},async updateMainAgent(e,t){try{const a={server_id:e.id,agent_instance_id:this.agentInstanceId,main_agent:t},i=await Object(n["optServerMainAgent"])(a,"post");if(0!==i.code)throw new Error(i.msg||"操作失败");this.$Message.success("设置成功"),this.dialog.show=!1,this.$emit("refresh"),this.$emit("bind-complete")}catch(a){throw a}},async setMainAgent(e){try{e.has_main_agent&&0!==e.bind_agnet_status?await this.showConfirmDialog(e):await this.showSetMainConfirm(e)}catch(t){this.$Message.error("设置主Agent失败: "+t.message)}},handlerChangePage(e){this.pageNum=e,this.setCurrentPageData()},setCurrentPageData(){const e=(this.pageNum-1)*this.pageSize,t=this.pageNum*this.pageSize;this.tableData=this.serverFilteredList.slice(e,t)},checkRegion(e){return e.region.indexOf(this.region)>=0},checkExecList(e){return e.name.indexOf(this.searchVal)>=0||e.cloud_name.indexOf(this.searchVal)>=0||e.inner_ip&&e.inner_ip.indexOf(this.searchVal)>=0||e.region&&e.region.indexOf(this.searchVal)>=0},handleFilter(){this.pageNum=1,this.searchVal?(this.searchVal=this.searchVal.trim(),this.serverFilteredList=this.serverList.filter(this.checkExecList)):this.serverFilteredList=this.serverList,this.setCurrentPageData()},initData(){this.serverFilteredList=this.serverList,this.pageNum=1,this.pageSize=10,this.searchVal=""}}}),o=r,l=a("2877"),d=Object(l["a"])(o,i,s,!1,null,null,null);t["default"]=d.exports},"9fce":function(e,t,a){},a308:function(e,t,a){"use strict";a("9fce")},aaa2:function(e,t,a){"use strict";a.r(t),a.d(t,"getServerList",(function(){return s})),a.d(t,"optServer",(function(){return n})),a.d(t,"optBatchServer",(function(){return r})),a.d(t,"getUserField",(function(){return o})),a.d(t,"optrationUserField",(function(){return l})),a.d(t,"optServerMainAgent",(function(){return d}));var i=a("be3b");const s=e=>Object(i["default"])({url:"/api/v2/cmdb/server/",method:"get",params:e}),n=(e,t)=>Object(i["default"])({url:"/api/v2/cmdb/server/",method:t,data:e}),r=(e,t)=>Object(i["default"])({url:"/api/v2/cmdb/server/batch/",method:t,data:e}),o=e=>Object(i["default"])({url:"/api/v2/cmdb/user_field/",method:"get",params:e}),l=e=>Object(i["default"])({url:"/api/v2/cmdb/user_field/",method:"put",data:e}),d=(e,t)=>Object(i["default"])({url:"/api/v2/cmdb/server/main_agent/",method:t,data:e})},ca83:function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"search-con search-con-top"},[t("div",{staticClass:"search-left"},[t("Input",{staticClass:"search-input",attrs:{search:"",maxlength:50,placeholder:"输入关键字搜索"},on:{"on-search":e.handleSearch},model:{value:e.initPara.searchVal,callback:function(t){e.$set(e.initPara,"searchVal",t)},expression:"initPara.searchVal"}}),t("span",{staticStyle:{"margin-left":"20px"}},[e._v("一键筛选：")]),t("ButtonGroup",["no"===e.initPara.search_filter?t("Button",{attrs:{type:"primary"},on:{click:function(t){return e.handlefilter("no")}}},[e._v("未绑定")]):t("Button",{on:{click:function(t){return e.handlefilter("no")}}},[e._v("未绑定")]),"yes"===e.initPara.search_filter?t("Button",{attrs:{type:"primary"},on:{click:function(t){return e.handlefilter("yes")}}},[e._v("已绑定")]):t("Button",{on:{click:function(t){return e.handlefilter("yes")}}},[e._v("已绑定")]),""===e.initPara.search_filter?t("Button",{attrs:{type:"primary"},on:{click:function(t){return e.handlefilter("")}}},[e._v("全部")]):t("Button",{on:{click:function(t){return e.handlefilter("")}}},[e._v("全部")])],1),e.instance_id?t("h4",{staticClass:"search-col"},[e._v("实例："+e._s(e.instance_id))]):e._e()],1),t("div",{staticClass:"search-right"},[e.instance_id?e._e():t("Button",{staticClass:"search-add-btn",attrs:{type:"primary",disabled:0===e.selectList.length},on:{click:e.handleBatchAddServer}},[e._v("生成主机 ")]),e.instance_id?e._e():t("Button",{staticClass:"search-add-btn",attrs:{type:"error",disabled:0===e.selectList.length},on:{click:e.handleDel}},[e._v("批量删除 ")])],1)]),t("Table",{ref:"selection",attrs:{size:"small",columns:e.tableColumns,data:e.tableData,loading:e.i.tableLoading},on:{"on-sort-change":e.handleSort,"on-selection-change":e.handleSelect}}),t("div",{staticStyle:{margin:"10px",overflow:"hidden"}},[t("div",{staticStyle:{float:"left"}},[t("Page",{attrs:{total:e.i.pageTotal,current:e.initPara.page_number,"page-size":e.initPara.page_size,"show-total":"","show-sizer":"","page-size-opts":[15,50,100,1e3]},on:{"on-change":e.handlerChangePage,"on-page-size-change":e.handlePageSize}})],1)]),e.spinShow?t("Spin",{attrs:{size:"large",fix:""}},[t("Icon",{staticClass:"demo-spin-icon-load",attrs:{type:"ios-loading",size:"18"}}),t("div",[e._v("加载中，请稍等一会...")])],1):e._e(),t("BindServer",{ref:"BindHost",attrs:{dialog:e.dialog}})],1)},s=[],n=(a("14d9"),a("3937")),r=a("aaa2"),o=a("00c4"),l=a("7281"),d={name:"Agent",components:{serverModal:o["default"],BindServer:l["default"]},props:{instance_id:{type:String,default:null},sg_ids:{type:Object|Array,default:null}},data(){return{modalData:{show:!1,title:"Nat详情"},dialog:{show:!1,title:"预览主机"},spinShow:!1,selectAgentId:null,tableColumns:[{type:"selection",key:"selection",width:60,align:"center"},{title:"主机名",key:"hostname",tooltip:!0,sortable:!0,minWidth:100},{title:"内网IP",key:"ip",ellipsis:!0,tooltip:!0,minWidth:100},{title:"proxy_id",key:"proxy_id",align:"center",minWidth:60},{title:"AgentID",key:"agent_id",minWidth:120},{title:"版本",key:"version",minWidth:20},{title:"状态",key:"agent_bind_status",align:"center",width:150,sortable:!0,render:(e,t)=>{const a=t.row.agent_bind_status;return 0===a?e("div",[e("Tag",{props:{color:"#ed3f14"}},"暂未绑定")]):1===a?e("div",[e("Tag",{props:{color:"#2d8cf0"}},"自动绑定")]):2===a?e("div",[e("Tag",{props:{color:"#19be6b"}},"手动绑定")]):void 0}},{title:"workspace",key:"workspace",minWidth:90},{title:"备注",key:"description",ellipsis:!0,tooltip:!0,minWidth:100},{title:"更新时间",key:"update_time",sortable:!0,width:170},{title:"操作",key:"handle",align:"center",width:200,render:(e,t)=>{const a=1===t.row.agent_bind_status||2===t.row.agent_bind_status;return e("div",[e("a",{props:{type:"primary",size:"small"},style:{marginRight:"10px"},on:{click:()=>{a?this.handleViewServer(t.row):this.handlePreview(t.row)}}},a?"查看主机":"绑定主机"),e("a",{style:{marginRight:"10px"},props:{size:"small"},on:{click:()=>{this.handleAddServer([t.row.id])}}},"生成主机")])}}],modalDataServer:{show:!1,title:"选择主机",action:"put"},tableData:[],i:{pageTotal:0,tableLoading:!0},initPara:{page_number:1,page_size:15,searchVal:null,sg_ids:[],order_by:"",order:"ascend",search_filter:"no"},searchParams:{page_number:1,page_size:12,search_filter:"no",order_by:"",order:"ascend"},selectList:[]}},methods:{async handleGetData(){const e=await Object(n["getAgentlist"])(this.initPara);0==e.code?(this.tableData=e.data,this.i.pageTotal=e.count):this.$Message.error(e.msg),this.i.tableLoading=!1},async handleViewServer(e){this.spinShow=!0;try{let t={page_number:1,page_size:300,search_filter:"is_normal",order_by:"id",order:"ascend"};const a=await Object(r["getServerList"])(t);if(0!==a.code)return this.$Message.error("获取主机列表失败: "+a.msg),void(this.spinShow=!1);this.$refs.BindHost.loadServerData(a.data,e.agent_id,e.id),this.dialog.title=`查看已绑定主机 (${e.agent_id})`,this.dialog.show=!0}catch(t){this.$Message.error(t.toString())}finally{this.spinShow=!1}},async handlePreview(e){this.spinShow=!0;try{let t=await Object(r["getServerList"])();if(0!==t.code)return void this.$Message.error(""+t.msg);this.$refs.BindHost.serverList=t.data,this.$refs.BindHost.agentInstanceId=e.id,this.dialog.show=!0,this.$refs.BindHost.$once("bind-complete",()=>{this.handleGetData(),this.dialog.show=!1})}catch(t){this.$Message.error(t.toString())}finally{this.spinShow=!1}},handleAddServer(e){this.$Modal.confirm({title:"二次确认",content:"确定生成主机？",onOk:()=>{let t=[];t=e||this.selectList,Object(n["batchAddServerByAgent"])({id_list:e},"post").then(e=>{0===e.code?(this.$Message.success(e.msg),this.selectList=[],this.handleGetData()):this.$Notice.error({title:""+e.msg})})},onCancel:()=>{}})},handleBatchAddServer(){this.$Modal.confirm({title:"二次确认",content:"确定生成主机？",onOk:()=>{Object(n["batchAddServerByAgent"])({id_list:this.selectList},"post").then(e=>{0===e.code?(this.$Message.success(e.msg),this.selectList=[],this.handleGetData()):this.$Notice.error({title:""+e.msg})})},onCancel:()=>{this.$Message.info("回头是岸~")}})},handlefilter(e){this.initPara.search_filter=e,this.handleGetData()},handleDel(){this.$Modal.confirm({title:"二次确认",content:"确定删除已选中的数据？",onOk:()=>{Object(n["optAgent"])({id_list:this.selectList},"delete").then(e=>{0===e.code?(this.$Message.success(e.msg),this.selectList=[],this.handleGetData()):this.$Notice.error({title:""+e.msg})})},onCancel:()=>{this.$Message.info("回头是岸~")}})},handleShowServer(e){this.modalDataServer.show=!0,this.$refs.serverModal.asset_server_id=e.asset_server_id,this.modalDataServer.title=`选择主机 【${e.agent_id}】`,this.modalDataServer.id=e.id},handleUpData(e){Object(n["optAgent"])(e,"patch").then(e=>{0==e.code?(this.$Message.success("成功"),this.handleClose()):this.$Message.error(e.msg)})},handleDetail(e){this.natData=e,this.modalData.show=!0},handleClose(){this.modalDataServer.show=!1,this.handleGetData()},handleSelect(e){let t=[];e.forEach(e=>{t.push(e.id)}),this.selectList=t},handleSearch(){this.initPara.page_number=1,this.handleGetData()},handleSort(e,t,a){this.initPara.order="asc"===e.order?"ascend":"descend",this.initPara.order_by=e.key,this.handleGetData()},handlerChangePage(e){this.initPara.page_number=e,this.handleGetData()},handlePageSize(e){this.initPara.page_number=1,this.initPara.page_size=e,this.handleGetData()}},watch:{searchValue(e){this.pageNum=1,this.handleGetData()},instance_id(e){this.pageNum=1,this.securityInfoList=[],this.handleGetData()},sg_ids(e){this.initPara["sg_ids"]=JSON.stringify(this.sg_ids),this.pageNum=1,this.securityInfoList=[],this.handleGetData()}},computed:{},mounted(){this.handleGetData()}},h=d,c=(a("a308"),a("2877")),g=Object(c["a"])(h,i,s,!1,null,"35962c0c",null);t["default"]=g.exports}}]);
//# sourceMappingURL=chunk-a93e94be.a613d76c.js.map