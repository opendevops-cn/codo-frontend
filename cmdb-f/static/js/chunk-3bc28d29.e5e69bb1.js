(window["webpackJsonp_cmdb"]=window["webpackJsonp_cmdb"]||[]).push([["chunk-3bc28d29","chunk-e652771c","chunk-581beae5","chunk-2d0a422c","chunk-2d0dec99","chunk-2d0ae8c9"],{"04c5":function(t,e,a){"use strict";a.r(e),a.d(e,"assetList",(function(){return i})),a.d(e,"columnTypeList",(function(){return s})),a.d(e,"operatorList",(function(){return n}));const i=[{value:"server",label:"服务器"},{value:"mysql",label:"MySQL"},{value:"redis",label:"Redis"},{value:"lb",label:"负载均衡"}],s=[{value:"name",label:"名称"},{value:"cloud_name",label:"厂商"},{value:"account_id",label:"用户"},{value:"region",label:"云区域"},{value:"inner_ip",label:"内网地址(主机)"},{value:"state",label:"运行状态"}],n=[{label:"包含",value:"包含"},{label:"正则",value:"正则"},{label:"等于",value:"=="},{label:"不等于",value:"!="},{label:"开始",value:"开始"},{label:"结束",value:"结束"}]},"0b12":function(t,e,a){"use strict";a.r(e),a.d(e,"postTreeAsset",(function(){return s})),a.d(e,"getTreeAsset",(function(){return n})),a.d(e,"changeTreeAssetStatus",(function(){return l})),a.d(e,"deleteTreeAsset",(function(){return o})),a.d(e,"getRelation",(function(){return r})),a.d(e,"getServiceTreelist",(function(){return c})),a.d(e,"operationTree",(function(){return d})),a.d(e,"getBizEnv",(function(){return h})),a.d(e,"getTreeModule",(function(){return u}));var i=a("be3b");const s=t=>Object(i["default"])({url:"/api/v2/cmdb/tree/asset/",method:"post",data:t}),n=t=>Object(i["default"])({url:"/api/v2/cmdb/tree/asset/",method:"get",params:t}),l=t=>Object(i["default"])({url:"/api/v2/cmdb/tree/asset/",method:"patch",data:t}),o=t=>Object(i["default"])({url:"/api/v2/cmdb/tree/asset/",method:"delete",data:t}),r=t=>Object(i["default"])({url:"/api/v2/cmdb/tree/asset/relation/",method:"get",params:t}),c=t=>Object(i["default"])({url:"/api/v2/cmdb/tree/",method:"get",params:t}),d=(t,e)=>Object(i["default"])({url:"/api/v2/cmdb/tree/",method:e,data:t}),h=t=>Object(i["default"])({url:"/api/v2/cmdb/tree/env/",method:"get",params:t}),u=t=>Object(i["default"])({url:"/api/v2/cmdb/tree/module/",method:"get",params:t})},"0e41":function(t,e,a){},"0e52":function(t,e,a){"use strict";a.r(e);var i=function(){var t=this,e=t._self._c;return e("div",[t.showEdit?e("rule-edit",{attrs:{formData:t.theData},on:{"save-data":t.handleSaveData,"edit-close":t.handleClose}}):e("Card",{attrs:{"dis-hover":"",bordered:!1}},[e("Alert",{attrs:{type:"success","show-icon":""}},[t._v(" 使用说明： "),e("Icon",{attrs:{slot:"icon",type:"ios-bulb-outline"},slot:"icon"}),e("template",{slot:"desc"},[t._v("制定动态规则，根据规则把资源划分到对应的拓扑中。")])],2),e("div",[e("div",{staticClass:"search-con search-con-top"},[e("Input",{staticClass:"search-input",attrs:{search:"",placeholder:"输入关键字全局搜索"},on:{"on-search":t.handleSearch},nativeOn:{keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.handleSearch.apply(null,arguments)}},model:{value:t.initPara.searchVal,callback:function(e){t.$set(t.initPara,"searchVal",e)},expression:"initPara.searchVal"}}),e("Button",{staticClass:"search-btn",on:{click:t.handleAdd}},[t._v("添加动态规则")])],1),e("Table",{attrs:{size:"small",columns:t.columns,data:t.tableData,loading:t.i.tableLoading}}),e("div",{staticStyle:{margin:"10px",overflow:"hidden"}},[e("div",{staticStyle:{float:"left"}},[e("Page",{attrs:{total:t.i.pageTotal,current:t.initPara.page_number,"page-size":t.initPara.page_size,"show-total":"","show-sizer":"","page-size-opts":[15,50,100]},on:{"on-change":t.handlerChangePage,"on-page-size-change":t.handlePageSize}})],1)])],1)],1),e("pre-view-asset",{ref:"preview",attrs:{modalData:t.modalData},on:{"preview-close":t.handleClose,refresh:t.handleRefresh,clean:t.handleClean}})],1)},s=[],n=(a("14d9"),a("86af")),l=a("660b"),o=a("15a44"),r={components:{ruleEdit:o["default"],preViewAsset:l["default"]},data(){return{jsonData:{},modalVisible:!1,delViewModal:!1,treeData:[],tableData:[],columns:[{type:"selection",title:"selection",key:"selection",width:60,align:"center"},{title:"规则名称",key:"name",minWidth:130,maxWidth:300},{title:"源类型",key:"asset_type",minWidth:110,maxWidth:140,align:"center"},{title:"规则",key:"condition_list",align:"center",minWidth:300,render:(t,e)=>{let a=JSON.parse(JSON.stringify(e.row.condition_list));return t("div",[Object.values(a).map(a=>t("p",`资源${e.row.asset_type}的[${a.src_type}]字段 通过[${a.src_operator}] 匹配关键字[${a.src_content}] `))])}},{title:"动作",key:"des_data",minWidth:150,tooltip:!0,render:(t,e)=>{let a,i=e.row.des_data;return i.length>=1&&(a=`划分到${e.row.asset_type} ${i[0]}`),i.length>=2&&(a=`划分到${e.row.asset_type} ${i[0]} / ${i[1]} `),i.length>=3&&(a=`划分到${e.row.asset_type} ${i[0]} / ${i[1]} / ${i[2]}`),i.length>=4&&(a=`划分到${e.row.asset_type} ${i[0]} / ${i[1]} / ${i[2]} / ${i[3]}`),t("div",[t("div",{style:{marginTop:"5px",marginBottom:"3px"}},a)])}},{title:"修改人",key:"modify_user",align:"center",minWidth:120,maxWidth:160},{title:"更新时间",key:"",minWidth:170,maxWidth:220,render:(t,e)=>t("div",[t("div",{style:{marginTop:"5px",marginBottom:"3px"}},""+e.row.update_time)])},{title:"操作",key:"handle",minWidth:170,render:(t,e)=>t("div",[t("a",{style:{marginRight:"10px"},on:{click:()=>{this.handlePreview(e.row)}}},"刷新"),t("a",{style:{marginRight:"10px"},on:{click:()=>{this.handleClone(e.row)}}},"克隆"),t("a",{style:{marginRight:"10px"},on:{click:()=>{this.handleEdit(e.row)}}},"编辑"),t("a",{style:{color:"red",marginRight:"10px"},on:{click:()=>{this.handleDel(e.row)}}},"删除")])}],modalData:{show:!1,title:"刷新动态规则",id:null,name:"",action:"put"},action:"post",showEdit:!1,selectList:[],theData:{},initForm:{des_type:"业务",des_data:null,interval:"no",condition_list:{0:{src_type:"name",src_operator:"==",src_content:""}}},initPara:{page_number:1,page_size:15,searchVal:null},i:{pageTotal:0,tableLoading:!1}}},methods:{async handleGetData(){const t=await Object(n["getDynamicRules"])(this.initPara);0==t.code?(this.tableData=t.data,this.i.pageTotal=t.count):this.$Message.error(t.msg)},handleClose(){this.showEdit=!1,this.modalData.show=!1,this.handleGetData(),this.selectList=[]},handleAdd(){this.action="post",this.showEdit=!0,this.theData=Object.assign(this.$options.data().theData,this.initForm)},handleEdit(t){this.action="put",this.showEdit=!0,this.theData=t},handleClone(t){this.action="post",this.showEdit=!0,delete t.id,t.name=t.name+"-副本",this.theData=t},handleSaveData(t){console.info(t),Object(n["optDynamicRule"])(t,this.action).then(t=>{console.info(t),0==t.code?(this.$Message.success("成功"),this.handleClose()):this.$Message.error(t.msg)})},handleDel(t){this.$Modal.confirm({title:"提醒",content:`<p>确认要删除规则  ${t.name} 之后无法找回, 请谨慎操作!</p>`,onOk:()=>{Object(n["optDynamicRule"])({id_list:[t.id]},"delete").then(t=>{0===t.code?(this.$Notice.success({title:""+t.msg}),this.handleGetData()):this.$Notice.error({title:""+t.msg})})},onCancel:()=>{this.$Message.info("回头是岸~")}})},async handlePreview(t){this.modalData.show=!0,this.modalData.name=t.name,this.modalData.id=t.id,this.$refs.preview.handleGetData(t.id)},async handleRefresh(t){let e=await Object(n["optDynamicRuleAsset"])(t,"put");0===e.code?(this.$Notice.success({title:""+e.msg}),this.handleClose()):this.$Notice.error({title:""+e.msg})},async handleClean(t){this.spinShow=!0;try{let e=await Object(n["optDynamicRuleAsset"])(t,"delete");if(0!==e.code)return void this.$Message.error(""+e.msg);this.$Message.info(""+e.msg),this.handleClose()}catch(e){this.$Message.error(e.toString())}finally{this.spinShow=!1}},handleSelect(t){let e=[];t.forEach(t=>{e.push(t.id)}),this.selectList=e},handleSearch(){this.initPara.page_number=1,this.handleGetData()},handlerChangePage(t){this.initPara.page_number=t,this.handleGetData()},handlePageSize(t){this.initPara.page_number=1,this.initPara.page_size=t,this.handleGetData()}},watch:{},mounted(){this.handleGetData()}},c=r,d=(a("9a85"),a("1b22"),a("2877")),h=Object(d["a"])(c,i,s,!1,null,"b2652b9a",null);e["default"]=h.exports},"15a44":function(t,e,a){"use strict";a.r(e);var i=function(){var t=this,e=t._self._c;return e("Card",{attrs:{bordered:!1,"dis-hover":""}},[e("Form",{ref:"formValidate",attrs:{model:t.formValidate,rules:t.ruleValidate,"label-colon":!0,"label-position":"top"}},[e("Row",[e("Col",{staticStyle:{padding:"15px 5px"},attrs:{span:"21",offset:"2"}},[e("span",{staticStyle:{color:"#464c5b","font-size":"16px","font-weight":"bold"}},[t._v("基础信息")])]),e("Col",{attrs:{span:"13",offset:"4"}},[e("Row",{attrs:{gutter:30}},[e("Col",{attrs:{span:"12"}},[e("FormItem",{attrs:{label:"规则名称",prop:"name"}},[e("Input",{attrs:{maxlength:"80",type:"text",placeholder:"请输入规则名称..."},model:{value:t.formValidate.name,callback:function(e){t.$set(t.formValidate,"name",e)},expression:"formValidate.name"}})],1)],1),e("Col",{attrs:{span:"12"}},[e("FormItem",{attrs:{label:"源类型"}},[e("Select",{staticClass:"rule-select",attrs:{filterable:"",placeholder:"请选择资源类型"},model:{value:t.formValidate.asset_type,callback:function(e){t.$set(t.formValidate,"asset_type",e)},expression:"formValidate.asset_type"}},t._l(t.assetList,(function(t){return e("Option",{key:t.value,attrs:{value:t.value,label:t.label}})})),1)],1)],1)],1),e("FormItem",{attrs:{label:"定时刷新"}},[e("RadioGroup",{attrs:{type:"button"},model:{value:t.formValidate.interval,callback:function(e){t.$set(t.formValidate,"interval",e)},expression:"formValidate.interval"}},[e("Radio",{attrs:{label:"yes",disabled:""}},[t._v("启用")]),e("Radio",{attrs:{label:"no"}},[t._v("禁用")])],1)],1),e("Alert",{attrs:{"show-icon":""}},[e("p",[t._v("挂载到上级会自动挂载到下级, 资源类的应都是挂载到服务或者模块")]),t._v(" 后续会根据不通的资源进行禁用")]),e("FormItem",{attrs:{label:"目标拓扑"}},[e("Cascader",{attrs:{data:t.treeData,"change-on-select":""},model:{value:t.formValidate.des_data,callback:function(e){t.$set(t.formValidate,"des_data",e)},expression:"formValidate.des_data"}})],1)],1),e("Col",{staticStyle:{padding:"15px 5px"},attrs:{span:"21",offset:"2"}},[e("span",{staticStyle:{color:"#464c5b","font-size":"16px","font-weight":"bold"}},[t._v("规则条件")])]),e("Col",{staticStyle:{"padding-right":"20px"},attrs:{span:"19",offset:"4"}},[e("p",{staticStyle:{"padding-bottom":"5px"}},[t._v("下列条件之间的关系为且(and)")]),t._l(t.formValidate.condition_list,(function(a,i){return e("FormItem",{key:i+t._uid},[e("div",{staticClass:"alert-con"},[e("Select",{staticClass:"rule-select",attrs:{filterable:""},model:{value:a.src_type,callback:function(e){t.$set(a,"src_type",e)},expression:"item.src_type"}},t._l(t.columnTypeList,(function(t){return e("Option",{key:t.value,attrs:{value:t.value,label:t.label,placeholder:"类型"}})})),1),e("Select",{staticClass:"rule-select1",attrs:{filterable:""},model:{value:a.src_operator,callback:function(e){t.$set(a,"src_operator",e)},expression:"item.src_operator"}},t._l(t.operatorList,(function(t){return e("Option",{key:t.value,attrs:{value:t.value,label:t.label}})})),1),e("Input",{staticClass:"rule-input1",attrs:{clearable:"",maxlength:90,placeholder:"值"},model:{value:a.src_content,callback:function(e){t.$set(a,"src_content",e)},expression:"item.src_content"}}),e("Button",{staticClass:"rule-btn-add",attrs:{shape:"circle",type:"text",icon:"md-add"},on:{click:function(e){return t.handleAdd(i)}}}),1!==t.mapLen?e("Button",{staticClass:"rule-btn-del",attrs:{shape:"circle",type:"text",icon:"md-close"},on:{click:function(e){return t.handleRemove(i)}}}):t._e()],1)])}))],2),e("Col",{attrs:{span:"19",offset:"4"}},[e("FormItem",{staticStyle:{padding:"0px 0px"}},[e("div",{staticStyle:{"padding-top":"12px"}},[e("Button",{attrs:{type:"primary",loading:t.btnLoading},on:{click:function(e){return t.handleSubmit("formValidate")}}},[t._v("确定")]),e("Button",{staticStyle:{"margin-left":"15px"},attrs:{type:"success",ghost:""},on:{click:t.handlePreview}},[t._v("预览规则")]),e("Button",{staticStyle:{"margin-left":"15px"},on:{click:t.handleCancel}},[t._v("返回")])],1)])],1)],1)],1)],1)},s=[],n=a("04c5"),l=a("0b12"),o={components:{},name:"ruleEdit",props:{formData:{type:Object,default:{}}},data(){return{btnLoading:!1,assetList:n["assetList"],operatorList:n["operatorList"],columnTypeList:n["columnTypeList"],mapLen:null,treeData:[],ruleValidate:{name:[{required:!0,message:"名称不能为空",trigger:"blur"}],status:[{required:!0,message:"不能为空",trigger:"change"}],channel_name:[{required:!0,type:"number",message:"不能为空",trigger:"change"}]}}},filters:{},methods:{handleCancel(){JSON.stringify(this.formValidate)!=JSON.stringify(this.formData)?this.$Modal.confirm({content:"<p>编辑还没有保存，确定要离开？</p>",onOk:()=>{this.$emit("edit-close")},onCancel:()=>{this.$Message.info("回头是岸")}}):this.$emit("edit-close")},async handleGetData(){const t=await Object(l["getServiceTreelist"])();0==t.code?(this.treeData=t.data,this.changeId2(this.treeData,"title","label","value")):this.$Message.error(t.msg)},changeId2(t,e,a,i){null!=t&&t.forEach(t=>{Object.assign(t,{[a]:t[e],[i]:t[e]}),this.changeId2(t.children,e,a,i)})},handleSubmit(t){this.$refs[t].validate(t=>{t?(this.btnLoading=!0,this.formValidate.name=this.formValidate.name.trim(),setTimeout(()=>{this.$emit("save-data",this.formValidate),this.btnLoading=!1},1e3)):this.$Message.error("表单校验不通过!")})},handleAdd(t){let e=Object.keys(this.formValidate.condition_list).length;console.info(typeof e),e>4?this.$Notice.warning({title:"限制提示",desc:"添加规则的个数不能超过五个",duration:5}):(this.formValidate.condition_list[e]={src_type:"name",src_operator:"==",src_content:""},console.info(this.formValidate.condition_list),this.formValidate.condition_list=JSON.parse(JSON.stringify(this.formValidate.condition_list)))},handleRemove(t){delete this.formValidate.condition_list[t],this.formValidate.condition_list=JSON.parse(JSON.stringify(this.formValidate.condition_list))},handlePreview(){this.$Notice.warning({title:"限制提示",desc:"请到列表处, 点击刷新可以预览数据",duration:5})}},watch:{formValidate(t){},"formValidate.condition_list":{handler(t,e){this.mapLen=Object.keys(this.formValidate.condition_list).length,console.log("正在被侦听",this.mapLen)},deep:!0}},computed:{formValidate:function(){return this.formData}},mounted(){this.handleGetData()}},r=o,c=(a("4765"),a("2877")),d=Object(c["a"])(r,i,s,!1,null,"131daf45",null);e["default"]=d.exports},"1b22":function(t,e,a){"use strict";a("0e41")},4765:function(t,e,a){"use strict";a("ee92")},"660b":function(t,e,a){"use strict";a.r(e);var i=function(){var t=this,e=t._self._c;return e("Drawer",{attrs:{title:t.modalData.title,styles:t.styles,width:"700px",draggable:"","mask-closable":!1},on:{"on-close":t.handleCancel},model:{value:t.modalData.show,callback:function(e){t.$set(t.modalData,"show",e)},expression:"modalData.show"}},[e("div",{staticStyle:{"padding-bottom":"5px","padding-left":"20px"}},[e("b",[t._v(t._s(t.modalData.name)+" ---- 共 "+t._s(t.listCount)+" 条")])]),t._l(t.listData,(function(a,i){return[e("p",{staticStyle:{"padding-left":"20px"}},[t._v(" "+t._s(a.cloud_name)+" -- "+t._s(a.name)+" -- "+t._s(a.instance_id)+" ")])]})),e("div",{staticClass:"drawer-footer"},[e("Button",{staticStyle:{"margin-right":"8px"},on:{click:t.handleCancel}},[t._v("取消")]),e("Button",{staticStyle:{"margin-right":"8px"},attrs:{type:"warning"},on:{click:function(e){return t.handleSubmit()}}},[t._v("刷新到指定业务")]),e("Button",{attrs:{type:"error"},on:{click:t.handleClean}},[t._v("清除当前资源的所有关联")])],1)],2)},s=[],n=a("86af"),l={components:{},name:"preViewAsset",props:{modalData:{type:Object,default:{}}},data(){return{listData:[],listCount:0,styles:{height:"calc(100% - 55px)",overflow:"auto",paddingBottom:"53px",position:"static"}}},filters:{},methods:{handleCancel(){this.$emit("preview-close")},async handleGetData(t){const e=await Object(n["getDynamicRuleAsset"])(t);0==e.code?(this.listData=e.data,this.listCount=e.count):this.$Message.error(e.msg)},handleSubmit(t){this.$emit("refresh",{id:this.modalData.id,force:t})},handleClean(){this.$emit("clean",{id:this.modalData.id})}},watch:{},computed:{},mounted(){}},o=l,r=(a("c58c"),a("2877")),c=Object(r["a"])(o,i,s,!1,null,null,null);e["default"]=c.exports},8588:function(t,e,a){},"86af":function(t,e,a){"use strict";a.r(e),a.d(e,"getDynamicRuleAsset",(function(){return s})),a.d(e,"optDynamicRuleAsset",(function(){return n})),a.d(e,"getDynamicRules",(function(){return l})),a.d(e,"optDynamicRule",(function(){return o}));var i=a("be3b");const s=t=>Object(i["default"])({url:"/api/v2/cmdb/dynamic_rule/pro/",method:"get",params:{id:t}}),n=(t,e)=>Object(i["default"])({url:"/api/v2/cmdb/dynamic_rule/pro/",data:t,method:e}),l=t=>Object(i["default"])({url:"/api/v2/cmdb/dynamic_rule/",method:"get",params:t}),o=(t,e)=>Object(i["default"])({url:"/api/v2/cmdb/dynamic_rule/",data:t,method:e})},"9a85":function(t,e,a){"use strict";a("b299")},b299:function(t,e,a){},c58c:function(t,e,a){"use strict";a("8588")},ee92:function(t,e,a){}}]);
//# sourceMappingURL=chunk-3bc28d29.e5e69bb1.js.map