"use strict";(self.webpackChunkcnmp=self.webpackChunkcnmp||[]).push([[8864],{81162:function(e,t,n){n.r(t);var o=n(73618),s=n(11527);t.default=function(){return(0,s.jsx)(o.Z,{type:"deployment"})}},73618:function(e,t,n){n.d(t,{Z:function(){return B}});var o=n(48305),s=n.n(o),i=n(17069),r=n.n(i),c=n(25298),u=n.n(c),a=n(21742),l=n.n(a),d=n(83136),h=n.n(d),p=n(53318),f=function(e){l()(n,e);var t=h()(n);function n(e){u()(this,n);var o="https:"===window.location.protocol?"wss://":"ws://",s=window.location.host;return t.call(this,"".concat(o).concat(s).concat("/api/cnmp-ws").concat(e))}return r()(n)}(n.n(p)()(WebSocket)),m=n(9699),v=n(48358),_=n(7034),b=(n(76684),n(65460)),w=n(32699),j=n.n(w),k=n(50959),y=n(45670),x=n(335),O=n.n(x),S=n(82092),g=n.n(S);function N(e,t,n){return e.addEventListener(t,n),{dispose:function(){n&&e.removeEventListener(t,n)}}}var T=function(){function e(t,n){u()(this,e),g()(this,"_socket",void 0),g()(this,"_bidirectional",void 0),g()(this,"_inputFormat",void 0),g()(this,"_outputFormat",void 0),g()(this,"_disposables",[]),this._socket=t,this._socket.binaryType="arraybuffer",this._bidirectional=!(n&&!1===n.bidirectional),this._inputFormat=null==n?void 0:n.inputFormat,this._outputFormat=null==n?void 0:n.outputFormat}return r()(e,[{key:"activate",value:function(e){var t=this;this._disposables.push(N(this._socket,"message",(function(n){var o=n.data;e.write("string"==typeof o?t._outputFormat?t._outputFormat(o):o:new Uint8Array(o))}))),this._bidirectional&&(this._disposables.push(e.onData((function(e){return t._sendData(e)}))),this._disposables.push(e.onBinary((function(e){return t._sendBinary(e)})))),this._disposables.push(N(this._socket,"close",(function(){return t.dispose()}))),this._disposables.push(N(this._socket,"error",(function(){return t.dispose()})))}},{key:"dispose",value:function(){var e,t=O()(this._disposables);try{for(t.s();!(e=t.n()).done;){e.value.dispose()}}catch(e){t.e(e)}finally{t.f()}}},{key:"_sendData",value:function(e){this._checkOpenSocket()&&this._socket.send(this._inputFormat?this._inputFormat(e):e)}},{key:"_sendBinary",value:function(e){if(this._checkOpenSocket()){for(var t=new Uint8Array(e.length),n=0;n<e.length;++n)t[n]=255&e.charCodeAt(n);this._socket.send(t)}}},{key:"_checkOpenSocket",value:function(){switch(this._socket.readyState){case WebSocket.OPEN:return!0;case WebSocket.CONNECTING:throw new Error("Attach addon was loaded before socket was open");case WebSocket.CLOSING:return console.warn("Attach addon socket is closing"),!1;case WebSocket.CLOSED:throw new Error("Attach addon socket is closed");default:throw new Error("Unexpected socket state")}}}]),e}(),Z=n(11527),F=function(e){var t=e.onOpen,n=e.inputFormat,o=e.outputFormat,s=e.onClose,i=e.theme,r=(0,k.useRef)(null),c=(0,k.useRef)(null),u=(0,k.useRef)(),a=(0,k.useRef)(),l=(0,m.t)("sidebar").collapsed,d=(0,k.useRef)(),h=(0,k.useRef)({rows:0,cols:0}),p=(0,k.useRef)({timeout:6e4,interval:3e3,timeoutObj:null,serverTimeoutObj:null,close:function(){this.timeoutObj&&clearTimeout(this.timeoutObj),this.serverTimeoutObj&&clearTimeout(this.serverTimeoutObj)},start:function(){var e=this;this.timeoutObj&&clearTimeout(this.timeoutObj),this.serverTimeoutObj&&clearTimeout(this.serverTimeoutObj);!function t(){e.timeoutObj=setTimeout((function(){var e;null===(e=a.current)||void 0===e||e.send(JSON.stringify({operation_type:"Ping"})),t()}),e.interval)}(),this.serverTimeoutObj=setTimeout((function(){var e;null===(e=a.current)||void 0===e||e.close(),console.log("ws---心跳无反应，中断")}),this.timeout)}});function w(){clearTimeout(u.current),u.current=setTimeout((function(){var e;null===(e=a.current)||void 0===e||e.close(),p.current.close(),console.log("ws---长时间未操作，中断"),null==s||s()}),36e5)}return(0,b.Z)((function(){setTimeout((function(){var e;null===(e=d.current)||void 0===e||e.call(d)}),200)}),[l]),(0,k.useEffect)((function(){var e=new _.Terminal({});c.current=e;var i=new v.FitAddon,u=function(){var t;i.fit();var n={rows:e.rows,cols:e.cols};(null===(t=a.current)||void 0===t?void 0:t.readyState)!==WebSocket.OPEN||j().isEqual(h.current,n)||(a.current.send(JSON.stringify({operation_type:"ResizeWindow",resize_window_info:n})),h.current=n)};return function(e){var i,r;a.current=new f("/api/v1/ws/pod/command");var u=new T(a.current,{outputFormat:o,inputFormat:n});null===(i=c.current)||void 0===i||i.loadAddon(u),null===(r=c.current)||void 0===r||r.reset(),a.current.onopen=function(){t(a.current),p.current.start(),null==e||e()},a.current.onmessage=function(){p.current.start()},a.current.onclose=function(){console.log("ws---终端"),null==s||s()}}((function(){u(),w()})),d.current=u,e.loadAddon(i),e.onData((function(){w()})),r.current&&e.open(r.current),window.addEventListener("resize",u),function(){var e;window.removeEventListener("resize",u),null===(e=a.current)||void 0===e||e.close()}}),[]),(0,k.useEffect)((function(){y[i]&&c.current&&(console.log(y[i]),c.current.options.theme=y[i])}),[i]),(0,Z.jsx)("div",{ref:r,style:{height:"calc(100vh - 210px)",width:"100%"},onClick:function(){w()}})},C=n(38218),E=n(81901),A=n(62069),R=n(62193),L=n(3885),W=n(4561),D=n(89169),P=n(13702),J=n(70334),U="block____RqDL",z="text___UwvyX",B=function(e){var t=(0,C.useParams)(),n=t.clusterName,o=void 0===n?"":n,i=t.namespace,r=void 0===i?"":i,c=t.podName,u=void 0===c?"":c,a=t.containerName,l=void 0===a?"":a,d=t.detailName,h=void 0===d?"":d,p=e.type,f=(0,k.useRef)(!0),m=(0,k.useState)(!1),v=s()(m,2),_=v[0],b=v[1],w=(0,E.Z)({shell:"/bin/bash"}),j=s()(w,2),x=j[0],O=j[1],S=(0,A.Z)("xterm-theme",{defaultValue:"AdventureTime"}),g=s()(S,2),N=g[0],T=g[1],B=p.split("-").map((function(e){return e.charAt(0).toUpperCase()+e.slice(1)})).join("");return(0,Z.jsxs)("div",{className:U,children:[(0,Z.jsxs)(R.Z,{justify:"space-between",style:{marginBottom:24},children:[(0,Z.jsx)(L.Z,{children:(0,Z.jsxs)(R.Z,{children:[(0,Z.jsx)("div",{style:{flexShrink:0},children:"namespace:"}),(0,Z.jsx)(W.Z,{title:r,children:(0,Z.jsx)("span",{className:z,children:r})}),(0,Z.jsxs)("div",{style:{flexShrink:0},children:["/ ",B,":"]}),(0,Z.jsx)(W.Z,{title:h,children:(0,Z.jsx)("span",{className:z,children:h})}),"pod"!==p&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)("div",{style:{flexShrink:0},children:"/ pod:"}),(0,Z.jsx)(W.Z,{title:u,children:(0,Z.jsx)("span",{className:z,children:u})})]}),(0,Z.jsx)("div",{style:{flexShrink:0},children:"/ 容器:"}),(0,Z.jsx)(W.Z,{title:l,children:(0,Z.jsx)("span",{className:z,children:l})})]})}),(0,Z.jsxs)(L.Z,{children:[_?(0,Z.jsx)(D.Z,{color:"green",children:"已连接"}):(0,Z.jsx)(D.Z,{color:"red",children:"未连接"}),(0,Z.jsx)("span",{children:"主题："}),(0,Z.jsx)(P.Z,{options:Object.keys(y).map((function(e){return{label:e,value:e}})),style:{width:160},value:N,onChange:T}),(0,Z.jsx)(P.Z,{value:x.shell,onChange:function(e){O({shell:e}),b(!1)},options:[{label:"sh",value:"/bin/sh"},{label:"bash",value:"/bin/bash"},{label:"powershell",value:"powershell"},{label:"cmd",value:"cmd"}],style:{width:140}})]})]}),(0,Z.jsx)(F,{theme:N,onClose:function(){b(!1)},onOpen:function(e){b(!0),e.send(JSON.stringify({operation_type:"Connect",connect_info:{cluster_name:o,namespace:r,pod_name:u,container_name:l,shell:x.shell}}))},inputFormat:function(e){return f.current?"":JSON.stringify({operation_type:"Command",command_info:{command:e}})},outputFormat:function(e){var t=JSON.parse(e);return f&&200===t.code&&(f.current=!1),200===t.code?t.data.output:(403===t.code&&J.ZP.error("没有操作权限"),J.ZP.error(t.msg),"")}},x.shell)]})}}}]);