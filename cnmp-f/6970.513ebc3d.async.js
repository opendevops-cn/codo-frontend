"use strict";(self.webpackChunkcnmp=self.webpackChunkcnmp||[]).push([[6970],{31962:function(e,n,t){var a=t(48305),r=t.n(a),i=t(31906),c=t(51142),s=t(81861),l=t(35028),o=t(59614),u=t(97628),d=t(50959),m=t(11527);n.Z=function(e){var n=e.onRefresh,t=e.onSave,a=e.defaultContent,p=e.editorHeight,h=void 0===p?300:p,f=e.disabledEdit,x=(0,d.useState)(!1),v=r()(x,2),y=v[0],j=v[1],g=(0,d.useState)(a),_=r()(g,2),Z=_[0],b=_[1],k=(0,d.useRef)(a);return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(c.Z,{justify:"space-between",children:y?(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(s.Z,{beforeUpload:function(e){var n=new FileReader;return n.readAsText(e),n.onload=function(e){var n,t=null===(n=e.target)||void 0===n?void 0:n.result;t&&b(t)},!1},accept:".yaml,.yml",showUploadList:!1,children:(0,m.jsx)(l.ZP,{type:"primary",children:"导入YAML"})}),(0,m.jsxs)(o.Z,{children:[(0,m.jsx)(l.ZP,{onClick:function(){j(!1),b(k.current)},children:"取消"}),(0,m.jsx)(l.ZP,{onClick:function(){t(Z).then((function(){k.current=Z,j(!1)}))},children:"确定"})]})]}):(0,m.jsxs)(o.Z,{children:[(0,m.jsx)(l.ZP,{type:"primary",onClick:function(){j(!0)},disabled:f,children:"编辑YAML"}),(0,m.jsx)(l.ZP,{onClick:function(){navigator.clipboard.writeText(Z).then((function(){u.ZP.success("复制成功")}))},children:"复制"}),(0,m.jsx)(l.ZP,{onClick:function(){null==n||n().then((function(e){b(e),u.ZP.success("刷新成功")}))},children:"刷新"})]})}),(0,m.jsx)("div",{style:{marginTop:20},children:(0,m.jsx)(i.ZP,{theme:"vs-dark",language:"yaml",value:Z,onChange:function(e){b(e||"")},height:h,options:{minimap:{enabled:!1},fontSize:14,readOnly:!y,scrollBeyondLastLine:!1}})})]})}},36970:function(e,n,t){t.d(n,{Z:function(){return de}});var a=t(90228),r=t.n(a),i=t(87999),c=t.n(i),s=t(48305),l=t.n(s),o=t(69346),u=t(60148),d=t(5726),m=t.n(d),p=t(11110),h=t.n(p);m().extend(h());var f=function(e){var n=Date.now()/1e3-e;return n<60?{duration:n,unit:"second"}:n<3600?{duration:Math.floor(n/60),unit:"minute"}:n<86400?{duration:Math.floor(n/3600),unit:"hour"}:{duration:Math.floor(n/86400),unit:"day"}},x=function(e){var n=f(e);return"second"===n.unit?"1分钟内":"".concat(n.duration," ").concat({second:"秒",minute:"分钟",hour:"小时",day:"天"}[n.unit],"前")},v=t(74538),y=t(18869),j=t(50959),g=t(11527),_=function(e){var n=e.detailData,t=(0,j.useState)(!1),a=l()(t,2),r=a[0],i=a[1],c=(0,j.useMemo)((function(){return[Object.keys(n.annotations||{}).map((function(e){return{value:"".concat(e,":").concat(n.annotations[e])}})),Object.keys(n.labels||{}).map((function(e){return{value:"".concat(e,":").concat(n.labels[e])}})),Object.keys(n.selector.matchLabels||{}).map((function(e){return{value:"".concat(e,":").concat(n.selector.matchLabels[e])}}))]}),[n]),s=c.some((function(e){return e.length>3})),d=(0,j.useMemo)((function(){return!s||r?c:c.map((function(e){return e.slice(0,3)}))}),[r,s]);return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(v.Z,{style:{marginBottom:20},children:(0,g.jsx)(y.Z,{title:"基础信息",items:[{key:"name",label:"名称",children:n.name},{key:"create_time",label:"创建时间",children:n.create_time},{key:"upadate_time",label:"更新时间",children:n.create_time},{key:"replicas",label:"副本数",children:n.replicas},{key:"status",label:"状态",children:"就绪: ".concat(n.status.readyReplicas,"/").concat(n.status.replicas," | 已更新: ").concat(n.status.updatedReplicas,"  | 可用: ").concat(n.status.availableReplicas," ")},{key:"update_strategy",label:"更新策略",children:n.update_strategy.type}]})}),(0,g.jsxs)(v.Z,{style:{marginBottom:20},children:[(0,g.jsx)(y.Z,{title:"注解&标签&选择器",items:[{key:"annotations",label:"注解",children:(0,g.jsx)(u.Z,{items:d[0],tagStyle:{maxWidth:300},direction:"vertical"})},{key:"labels",label:"标签",children:(0,g.jsx)(u.Z,{items:d[1],tagStyle:{maxWidth:300},direction:"vertical"})},{key:"selector",label:"选择器",children:(0,g.jsx)(u.Z,{items:d[2],tagStyle:{maxWidth:300},direction:"vertical"})}]}),s&&(0,g.jsx)("div",{style:{textAlign:"right"},children:(0,g.jsx)("a",{onClick:function(){i(!r)},children:r?"收起":"展开"})})]}),(0,g.jsx)(o.Z,{dataSource:n.conditions,columns:[{title:"类型",dataIndex:"type"},{title:"状态",dataIndex:"status"},{title:"reason",dataIndex:"reason"},{title:"message",dataIndex:"message"},{title:"lastHeartbeatTime",dataIndex:"lastUpdateTime",render:x},{title:"lastTransitionTime",dataIndex:"lastTransitionTime",render:x}],leftTitle:"健康检查"})]})},Z=t(30813),b=t(27948),k=t(60396),w=t(58082),P=t(29882),R={deployment:0,"clone-set":4,"game-server-set":5,"stateful-set":1,"daemon-set":2},C=t(30433),N=t(32030),S=t(67074),I=t(10534),L=t(47212),M=t(97628),O=t(51142),T=t(59614),D=t(35028),J=t(88934),Y=t(6910),F=t(38616),W=t(82187),A=t.n(W),B=t(86631),H="tab-container___c_0la",U="tab-bar-content___k4CDX",E="not-ready___DM7Jj",z="tab-bar-content-state___W_Pf7",V="not-ready-container___JCWLF",q=function(e){var n,t=e.detailData,a=e.active,r=e.type,i=e.operationRender,c=(0,w.J)(),s=(0,S.Z)({pod:""}),o=l()(s,2),u=o[0],d=o[1],m=(0,N.useParams)(),p=m.clusterName,h=void 0===p?"":p,x=m.name,v=void 0===x?"":x,y=m.namespace,_=void 0===y?"":y,W=(0,N.useNavigate)(),q=(0,j.useState)(t.replicas),K=l()(q,2),X=K[0],$=K[1],G=(0,I.Z)((function(e){C.J[r].scale({name:v,cluster_name:h,namespace:_,replicas:e}).then((function(){M.ZP.success("修改成功"),c()}))}),{wait:500}).run,Q=(0,L.Z)((function(){return(0,Z.oZ)({cluster_name:h,namespace:_,controller_name:v,list_all:"",controller_type:R[r]}).then((function(e){return e.list}))}),{pollingInterval:2e3,pollingWhenHidden:!1,manual:!0}),ee=Q.data,ne=void 0===ee?[]:ee,te=Q.run,ae=Q.cancel;(0,j.useEffect)((function(){a?te():ae()}),[a]);var re=(0,j.useMemo)((function(){return ne.map((function(e){var n,t,a=e.isReady;return{key:e.name,label:(0,g.jsx)("div",{className:A()(U,!a&&E),children:(0,g.jsxs)(O.Z,{vertical:!0,justify:"space-between",style:{height:"100%"},children:[(0,g.jsxs)(O.Z,{justify:"space-between",children:[(0,g.jsx)("div",{children:e.name||""}),(0,g.jsx)("div",{className:z,children:a?"Ready":"Not-Ready"})]}),(0,g.jsxs)(O.Z,{justify:"space-between",children:[(0,g.jsxs)("div",{children:[(n=Number(e.creationTimestamp||0),t=f(n),"second"===t.unit?"1分钟内":"约".concat(t.duration).concat({second:"秒",minute:"分钟",hour:"小时",day:"天"}[t.unit]))," "]}),(0,g.jsxs)("div",{children:["节点IP：",e.pod_ip||"-"," "]}),(0,g.jsxs)("div",{children:["实例IP：",e.node_ip||"-"," "]})]})]})}),children:(0,g.jsx)(B.Z,{data:e,type:r})}}))||[]}),[ne]);return(0,j.useEffect)((function(){var e;!u.pod&&null!=re&&null!==(e=re[0])&&void 0!==e&&e.key&&d({pod:re[0].key})}),[re]),(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)(T.Z,{style:{marginBottom:10},children:[(0,g.jsx)("span",{children:"副本数"}),(0,g.jsx)(b.Z,{style:{width:160},value:X,onChange:function(e){G(e),$(e)}}),(0,g.jsx)(k.Z,{modalRender:function(e){return(0,g.jsx)(P.Z,{defaultValue:t.yaml,clusterName:h,onCancel:function(){e()},onOk:function(){c()},sourceType:r})},children:(0,g.jsx)(D.ZP,{type:"primary",ghost:!0,children:"编辑YAML"})}),(0,g.jsx)(k.Z,{modalRender:function(e){return(0,g.jsxs)(J.Z,{open:!0,title:"【".concat(v,"】重启"),onCancel:function(){e()},onOk:function(){C.J[r].restart({name:v,cluster_name:h,namespace:_}).then((function(){c(),M.ZP.success("修改成功")}))},children:["确认重新部署：",v,"？"]})},children:(0,g.jsx)(Y.ZP,{theme:{token:{colorPrimary:"#faad14"}},children:(0,g.jsx)(D.ZP,{type:"primary",ghost:!0,children:"重启"})})}),(0,g.jsx)(k.Z,{modalRender:function(e){return(0,g.jsxs)(J.Z,{open:!0,title:"【".concat(v,"】删除"),onCancel:function(){e()},onOk:function(){C.J[r].delete({name:v,cluster_name:h,namespace:_}).then((function(){W("/cluster/".concat(h,"/deployment")),M.ZP.success("删除成功")}))},children:["确认删除资源：",v,"？"]})},children:(0,g.jsx)(D.ZP,{danger:!0,children:"删除"})}),null==i?void 0:i()]}),(0,g.jsx)(F.Z,{onChange:function(e){d({pod:e})},activeKey:u.pod,tabPosition:"left",items:re,className:A()(H,!(null!==(n=ne.find((function(e){return e.name===u.pod})))&&void 0!==n&&n.isReady)&&V)})]})},K=t(31962),X=t(12710),$=function(e){var n=e.type,t=(0,N.useParams)(),a=t.clusterName,i=void 0===a?"":a,s=t.name,l=void 0===s?"":s,d=t.namespace,m=void 0===d?"":d,p=(0,j.useRef)();return(0,g.jsx)(o.Z,{tableProps:{style:{marginTop:-16}},showSearch:!1,actionRef:p,request:c()(r()().mark((function e(){var t;return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,C.J[n].replicasetList({cluster_name:i,namespace:m,name:l});case 2:return t=e.sent,e.abrupt("return",{data:t.list||[],total:t.total||0});case 4:case"end":return e.stop()}}),e)}))),columns:[{title:"版本",dataIndex:"version"},{title:"镜像",dataIndex:"images",render:function(e){return(0,g.jsx)(u.Z,{items:e.map((function(e){return{value:e}}))})}},{title:"版本详情",dataIndex:"yaml",render:function(e){return(0,g.jsx)(k.Z,{modalRender:function(n){return(0,g.jsx)(P.Z,{clusterName:i,defaultValue:e,onCancel:n,readonly:!0,sourceType:"deployment"})},children:(0,g.jsx)("a",{children:"查看YAML"})})}},{title:"创建时间",dataIndex:"create_time"},{title:"操作",dataIndex:"is_current",render:function(e,t){return(0,g.jsx)("a",{className:A()(e&&"disabled-link"),onClick:function(){J.Z.confirm({title:"【".concat(l,"】回滚"),content:"确认回滚：".concat(l,"到").concat(t.version,"？"),onOk:function(){C.J[n].rollback({cluster_name:i,name:l,namespace:m,version:t.version}).then((function(){var e;M.ZP.success("操作成功"),null===(e=p.current)||void 0===e||e.reload()}))}})},children:"回滚"})}}]})},G=t(12446),Q=t(75419),ee=t(31906),ne=t(358),te=t(83877),ae=t(94687),re=t(17385);var ie=t(59592),ce=function(e){var n=e.cancel,t=e.podName,a=e.containerName,r=(0,j.useState)(1),i=l()(r,2),c=i[0],s=i[1],o=(0,N.useParams)(),u=o.clusterName,d=void 0===u?"":u,m=o.namespace,p=void 0===m?"":m;return(0,g.jsx)(J.Z,{title:"下载日志",open:!0,onCancel:n,onOk:function(){var e=Math.floor((new Date).getTime()/1e3-60*c*60);(0,Z.$Y)({start_time:e,cluster_name:d,namespace:p,container_name:a,pod_name:t}).then((function(e){var n,r,i,s,l;""!==e.data?(n=(0,ie.Jx)(e.data),r="".concat(t,"-").concat(a,"-最近").concat(c,"小时日志"),i=new Blob([n],{type:"text/plain"}),s=URL.createObjectURL(i),(l=document.createElement("a")).href=s,l.download=r,l.click(),URL.revokeObjectURL(s)):M.ZP.warning("最近".concat(c,"小时没有日志"))}))},children:(0,g.jsxs)(T.Z,{children:[(0,g.jsx)("span",{children:"下载最近"}),(0,g.jsx)(b.Z,{min:0,style:{width:160},value:c,onChange:function(e){null!==e&&s(e)}}),(0,g.jsx)("span",{children:"小时的日志"})]})})},se="editor___UAXD6",le="fullscreen___OWie9";var oe=function(e){var n=e.type,t=(0,j.useState)(!1),a=l()(t,2),r=a[0],i=a[1],c="https:"===window.location.protocol?"wss://":"ws://",s=window.location.host,o=(0,N.useParams)(),u=o.clusterName,d=void 0===u?"":u,m=o.name,p=void 0===m?"":m,h=o.namespace,f=void 0===h?"":h,x=(0,j.useState)(!0),v=l()(x,2),y=v[0],_=v[1],b=(0,j.useState)(!0),w=l()(b,2),P=w[0],C=w[1],I=(0,j.useRef)({log:"",num:0}),L=(0,j.useRef)(null),M="".concat(c).concat(s).concat("/api/cnmp-ws","/api/v1/ws/pod/log"),J=(0,j.useState)(""),Y=l()(J,2),F=Y[0],W=Y[1],B=(0,j.useState)(100),H=l()(B,2),U=H[0],E=H[1],z=(0,S.Z)(),V=l()(z,1)[0],q=(0,j.useState)([]),K=l()(q,2),X=K[0],$=K[1],ie=(0,j.useState)(V.pod_name?"".concat(V.pod_name,"/").concat(V.container_name):""),oe=l()(ie,2),ue=oe[0],de=oe[1];(0,j.useEffect)((function(){(0,Z.oZ)({cluster_name:d,namespace:f,controller_name:p,list_all:"",controller_type:R[n]}).then((function(e){var n,t;($(e.list),""===ue)&&de("".concat(null===(n=e.list)||void 0===n||null===(n=n[0])||void 0===n?void 0:n.name,"/").concat(null===(t=e.list)||void 0===t||null===(t=t[0])||void 0===t||null===(t=t.containers)||void 0===t?void 0:t[0].container_name))}))}),[]);var me=(0,ne.Z)(M,{onMessage:function(e){var n=JSON.parse(e.data);200===n.code&&(I.current={log:I.current.log+n.data.log,num:I.current.num+1},P&&W(I.current.log))}}),pe=me.sendMessage,he=me.readyState;(0,j.useEffect)((function(){1===he&&ue&&(W(""),pe(JSON.stringify({cluster_name:d,namespace:f,pod_name:ue.split("/")[0],container_name:ue.split("/")[1],tail_lines:U})))}),[he,ue,U]);var fe=(0,j.useMemo)((function(){return X.map((function(e){return{value:e.name,title:e.name,selectable:!1,children:e.containers.map((function(n){return{value:"".concat(e.name,"/").concat(n.container_name),title:n.container_name,label:"".concat(e.name,"/").concat(n.container_name)}}))}}))}),[X]);return(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("div",{className:A()(r&&le),children:[(0,g.jsxs)(O.Z,{justify:"space-between",style:{marginBottom:24},children:[(0,g.jsxs)(T.Z,{children:[(0,g.jsx)("span",{children:"选择容器"}),(0,g.jsx)(te.Z,{treeDefaultExpandAll:!0,value:ue,treeData:fe,style:{width:360},onChange:function(e){de(e)},treeNodeLabelProp:"label"}),(0,g.jsx)(ae.Z,{value:U,onChange:function(e){E(e),pe(JSON.stringify({cluster_name:d,namespace:f,pod_name:V.pod_name,container_name:V.container_name,tail_lines:e}))},options:[{label:"100条",value:100},{label:"200条",value:200},{label:"500条",value:500},{label:"1000条",value:1e3}],style:{width:100}})]}),(0,g.jsxs)(T.Z,{children:[(0,g.jsx)("span",{children:"自动刷新"}),(0,g.jsx)(re.Z,{style:{marginRight:10},checked:P,onChange:function(e){e&&W(I.current.log),C(e)}}),(0,g.jsx)("span",{children:"自动换行"}),(0,g.jsx)(re.Z,{style:{marginRight:10},checked:y,onChange:function(e){return _(e)}}),(0,g.jsx)(k.Z,{modalRender:function(e){return(0,g.jsx)(ce,{cancel:e,podName:ue.split("/")[0],containerName:ue.split("/")[1]})},children:(0,g.jsx)(D.ZP,{style:{marginRight:10},children:"下载日志"})}),(0,g.jsx)(D.ZP,{onClick:function(){i(!r)},children:r?(0,g.jsx)(G.Z,{}):(0,g.jsx)(Q.Z,{})})]})]}),(0,g.jsx)(ee.ZP,{theme:"vs-dark",language:"yaml",onMount:function(e){L.current=e},value:F,onChange:function(){!function(e){var n=e.getModel().getLineCount(),t=e.getVisibleRanges();if(t.length>0&&t[t.length-1].endLineNumber>=n)return;e.revealLine(n)}(L.current)},className:se,options:{minimap:{enabled:!1},fontSize:14,wordWrap:y?"on":"off",readOnly:!0,scrollBeyondLastLine:!1}})]})})},ue="detail-tabs___idgPM",de=function(e){var n=(0,N.useParams)(),t=n.clusterName,a=void 0===t?"":t,i=n.name,s=void 0===i?"":i,u=n.namespace,d=void 0===u?"":u,p=e.type,h=e.operationRender,f=(0,L.Z)((function(){return C.J[p].detail({name:s,cluster_name:a,namespace:d}).then((function(e){return e.detail}))}),{pollingInterval:2e3,pollingWhenHidden:!1}).data,x=(0,S.Z)({tab:"pods"}),v=l()(x,2),y=v[0],j=v[1];return f?(0,g.jsx)(g.Fragment,{children:f&&(0,g.jsx)(F.Z,{className:ue,activeKey:y.tab,onChange:function(e){j({tab:e})},items:[{key:"pods",label:"Pods",children:(0,g.jsx)(q,{detailData:f,active:"pods"===y.tab,type:p,operationRender:h})},{key:"history",label:"历史版本",children:(0,g.jsx)($,{type:p})},{key:"info",label:"基础信息",children:(0,g.jsx)(_,{detailData:f})},{key:"event",label:"事件",children:(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(X.Z,{message:"只展示最近 1 小时内发生的事件信息，请及时查看。",type:"info",showIcon:!0,style:{marginBottom:24}}),(0,g.jsx)(o.Z,{request:function(){var e=c()(r()().mark((function e(n){var t;return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,Z.LO)({cluster_name:a,controller_name:f.name||"",namespace:d,keyword:n.keyword,page:n.current,page_size:n.pageSize,controller_type:R[p]});case 2:return t=e.sent,e.abrupt("return",{data:t.list||[],total:t.total||0});case 4:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),tableProps:{scroll:{x:1e3}},columns:[{title:"首次出现时间",dataIndex:"first_time_stamp",width:160,render:function(e){return m()(1e3*e).format("YYYY-MM-DD HH:mm:ss")}},{title:"最近出现时间",dataIndex:"last_time_stamp",width:160,render:function(e){return m()(1e3*e).format("YYYY-MM-DD HH:mm:ss")}},{title:"事件等级",dataIndex:"type",width:120,render:function(e){return(0,g.jsx)("span",{style:{color:"Warning"===e?"#FF4D4F":""},children:e})}},{title:"资源类型",dataIndex:"involved_object_kind",width:120},{title:"资源名称",dataIndex:"involved_object_name",width:160,ellipsis:!0},{title:"内容",dataIndex:"reason",width:200,ellipsis:!0},{title:"消息",dataIndex:"message",width:300,ellipsis:!0},{title:"出现次数",dataIndex:"count",width:120}],leftTitle:"健康检查"})]})},{key:"log",label:"日志",destroyInactiveTabPane:!0,children:(0,g.jsx)(oe,{type:p})},{key:"yaml",label:"YAML",children:(0,g.jsx)(K.Z,{defaultContent:f.yaml,onRefresh:c()(r()().mark((function e(){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",C.J[p].detail({name:s,cluster_name:a,namespace:d}).then((function(e){var n;return M.ZP.success("刷新成功"),(null===(n=e.detail)||void 0===n?void 0:n.yaml)||""})));case 1:case"end":return e.stop()}}),e)}))),onSave:function(){var e=c()(r()().mark((function e(n){return r()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",C.J[p].createOrUpdateByYaml({yaml:n,cluster_name:a}).then((function(){M.ZP.success("编辑成功")})));case 1:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),editorHeight:"calc(100vh - 380px)"})}]})}):null}}}]);