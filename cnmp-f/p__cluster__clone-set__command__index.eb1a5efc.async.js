"use strict";(self.webpackChunkcnmp=self.webpackChunkcnmp||[]).push([[3704],{15157:function(e,t,n){n.r(t);var o=n(31214),r=n(11527);t.default=function(){return(0,r.jsx)(o.Z,{type:"game-server-set"})}},31214:function(e,t,n){n.d(t,{Z:function(){return P}});var o=n(48305),r=n.n(o),s=n(17069),i=n.n(s),a=n(25298),c=n.n(a),u=n(21742),l=n.n(u),d=n(83136),p=n.n(d),h=n(53318),f=function(e){l()(n,e);var t=p()(n);function n(e){c()(this,n);var o="https:"===window.location.protocol?"wss://":"ws://",r=window.location.host;return t.call(this,"".concat(o).concat(r).concat("/api/cnmp-ws").concat(e))}return i()(n)}(n.n(h)()(WebSocket)),v=n(83264),m=n(48358),_=n(7034),w=(n(34117),n(65460)),k=n(32699),b=n.n(k),y=n(50959),S=n(45670),F=n(335),g=n.n(F),N=n(82092),O=n.n(N);function j(e,t,n){return e.addEventListener(t,n),{dispose:function(){n&&e.removeEventListener(t,n)}}}var x=function(){function e(t,n){c()(this,e),O()(this,"_socket",void 0),O()(this,"_bidirectional",void 0),O()(this,"_inputFormat",void 0),O()(this,"_outputFormat",void 0),O()(this,"_disposables",[]),this._socket=t,this._socket.binaryType="arraybuffer",this._bidirectional=!(n&&!1===n.bidirectional),this._inputFormat=null==n?void 0:n.inputFormat,this._outputFormat=null==n?void 0:n.outputFormat}return i()(e,[{key:"activate",value:function(e){var t=this;this._disposables.push(j(this._socket,"message",(function(n){var o=n.data;e.write("string"==typeof o?t._outputFormat?t._outputFormat(o):o:new Uint8Array(o))}))),this._bidirectional&&(this._disposables.push(e.onData((function(e){return t._sendData(e)}))),this._disposables.push(e.onBinary((function(e){return t._sendBinary(e)})))),this._disposables.push(j(this._socket,"close",(function(){return t.dispose()}))),this._disposables.push(j(this._socket,"error",(function(){return t.dispose()})))}},{key:"dispose",value:function(){var e,t=g()(this._disposables);try{for(t.s();!(e=t.n()).done;){e.value.dispose()}}catch(e){t.e(e)}finally{t.f()}}},{key:"_sendData",value:function(e){this._checkOpenSocket()&&this._socket.send(this._inputFormat?this._inputFormat(e):e)}},{key:"_sendBinary",value:function(e){if(this._checkOpenSocket()){for(var t=new Uint8Array(e.length),n=0;n<e.length;++n)t[n]=255&e.charCodeAt(n);this._socket.send(t)}}},{key:"_checkOpenSocket",value:function(){switch(this._socket.readyState){case WebSocket.OPEN:return!0;case WebSocket.CONNECTING:throw new Error("Attach addon was loaded before socket was open");case WebSocket.CLOSING:return console.warn("Attach addon socket is closing"),!1;case WebSocket.CLOSED:throw new Error("Attach addon socket is closed");default:throw new Error("Unexpected socket state")}}}]),e}(),E=n(11527),C=function(e){var t=e.onOpen,n=e.inputFormat,o=e.outputFormat,r=e.onClose,s=e.theme,i=(0,y.useRef)(null),a=(0,y.useRef)(null),c=(0,y.useRef)(),u=(0,y.useRef)(),l=(0,v.t)("sidebar").collapsed,d=(0,y.useRef)(),p=(0,y.useRef)({rows:0,cols:0});function h(){clearTimeout(c.current),c.current=setTimeout((function(){var e;console.log("用户长时间未输入"),null===(e=u.current)||void 0===e||e.close(),null==r||r()}),3e5)}return(0,w.Z)((function(){setTimeout((function(){var e;null===(e=d.current)||void 0===e||e.call(d)}),200)}),[l]),(0,y.useEffect)((function(){var e=new _.Terminal({});a.current=e;var r=new m.FitAddon,s=function(){var t;r.fit();var n={rows:e.rows,cols:e.cols};(null===(t=u.current)||void 0===t?void 0:t.readyState)!==WebSocket.OPEN||b().isEqual(p.current,n)||(u.current.send(JSON.stringify({operation_type:2,resize_window_info:n})),p.current=n)};return function(e){var r,s;u.current=new f("/api/v1/ws/pod/command");var i=new x(u.current,{outputFormat:o,inputFormat:n});null===(r=a.current)||void 0===r||r.loadAddon(i),null===(s=a.current)||void 0===s||s.reset(),u.current.onopen=function(){t(u.current),null==e||e()}}((function(){s(),h()})),d.current=s,e.loadAddon(r),e.onData((function(){h()})),i.current&&e.open(i.current),window.addEventListener("resize",s),function(){var e;window.removeEventListener("resize",s),null===(e=u.current)||void 0===e||e.close()}}),[]),(0,y.useEffect)((function(){S[s]&&a.current&&(console.log(S[s]),a.current.options.theme=S[s])}),[s]),(0,E.jsx)("div",{ref:i,style:{height:"calc(100vh - 210px)",width:"100%"},onClick:function(){h()}})},A="block___u4hkW",Z=n(32030),R=n(70567),T=n(51142),W=n(59614),L=n(94687),D=n(97628),P=function(e){var t=(0,Z.useParams)(),n=t.clusterName,o=void 0===n?"":n,s=t.namespace,i=void 0===s?"":s,a=t.podName,c=void 0===a?"":a,u=t.containerName,l=void 0===u?"":u,d=t.detailName,p=void 0===d?"":d,h=e.type,f=(0,y.useRef)(!0),v=(0,y.useState)(!1),m=r()(v,2),_=m[0],w=m[1],k=(0,y.useState)("/bin/bash"),b=r()(k,2),F=b[0],g=b[1],N=(0,R.Z)("xterm-theme",{defaultValue:"AdventureTime"}),O=r()(N,2),j=O[0],x=O[1],P=h.split("-").map((function(e){return e.charAt(0).toUpperCase()+e.slice(1)})).join("");return(0,E.jsxs)("div",{className:A,children:[(0,E.jsxs)(T.Z,{justify:"space-between",style:{marginBottom:24},children:[(0,E.jsx)(W.Z,{children:(0,E.jsxs)("span",{children:["namespace:",i," / ",P,":",p," / pod:",c," / 容器:",l]})}),(0,E.jsxs)(W.Z,{children:[_&&(0,E.jsx)("span",{style:{color:"var(--color-error)"},children:"已断开"}),(0,E.jsx)(L.Z,{options:Object.keys(S).map((function(e){return{label:e,value:e}})),style:{width:160},value:j,onChange:x}),(0,E.jsx)(L.Z,{value:F,onChange:function(e){g(e),w(!1)},options:[{label:"sh",value:"/bin/sh"},{label:"bash",value:"/bin/bash"},{label:"powershell",value:"powershell"},{label:"cmd",value:"cmd"}],style:{width:140}})]})]}),(0,E.jsx)(C,{theme:j,onClose:function(){w(!0)},onOpen:function(e){e.send(JSON.stringify({operation_type:1,connect_info:{cluster_name:o,namespace:i,pod_name:c,container_name:l,shell:F}}))},inputFormat:function(e){return f.current?"":JSON.stringify({operation_type:3,command_info:{command:e}})},outputFormat:function(e){var t=JSON.parse(e);return f&&200===t.code&&(f.current=!1),200===t.code?t.data.output:(403===t.code&&D.ZP.error("没有操作权限"),D.ZP.error(t.msg),"")}},F)]})}}}]);